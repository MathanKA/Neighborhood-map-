var NeighborhoodViewModel=function(){var e=this;e.loading=ko.observable(!0),e.error=ko.observable(!1),e.errorText=ko.observable(""),e.neighborhood={name:ko.observable("Udacity"),location:{lat:37.399864,lng:-122.10840000000002}},e.map=null,e.switchInputValue=ko.observable(""),e.searchInputValue=ko.observable(""),e.categories=ko.observableArray([]),e.hasPlaces=ko.observable(!0),e.initialize=function(){var o={disableDefaultUI:!0,center:e.neighborhood.location,zoom:18,zoomControl:!0,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_CENTER,style:google.maps.ZoomControlStyle.DEFAULT}};e.map=new google.maps.Map(document.getElementById("map-canvas"),o),e.getCategories(function(o){o.forEach(function(e){e.isVisible=ko.observable(!0),e.isHidden=ko.computed(function(){return!e.isVisible()}),e.toggleVisibility=function(){this.isVisible(!e.isVisible()),this.places().forEach(function(e){e.infoWindowOpened()&&(e.infoWindow.close(),e.marker.setIcon(e.markerIcon),e.infoWindowOpened(!1)),e.matchesQuery()&&e.marker.setVisible(!e.marker.getVisible())})},e.places=ko.observableArray([]),e.placesMatchingQuery=ko.computed(function(){var o=[];return e.places().forEach(function(e){var r=e.matchesQuery();e.marker.setVisible(r),r?o.push(e):e.infoWindowOpened()&&(e.infoWindow.close(),e.marker.setIcon(e.markerIcon),e.infoWindowOpened(!1))}),o}),e.headerIcon=ko.computed(function(){var o=e.icon;return o.prefix+"44"+o.suffix}),e.displayName=ko.computed(function(){return e.pluralName.length>22?e.pluralName.substring(0,18)+" â€¦":e.pluralName})}),e.categories(o),e.findPlaces(e.neighborhood),e.activateNeighborhoodSwitch()})},e.activateNeighborhoodSwitch=function(){var o=document.getElementById("neighborhood"),r=new google.maps.places.SearchBox(o);google.maps.event.addListener(r,"places_changed",function(){e.categories().forEach(function(e){e.places().forEach(function(e){e.marker.setMap(null),e.marker=null}),e.places([])});var o=r.getPlaces();if(e.switchInputValue(""),0!==o.length){var n=o[0];if(n.hasOwnProperty("geometry")){var a=n.geometry;if(a.hasOwnProperty("location")){var t=a.location;e.neighborhood.name(n.name),e.neighborhood.location.lat=t.lat(),e.neighborhood.location.lng=t.lng(),e.switchNeighborhood(e.neighborhood)}}}})},e.switchNeighborhood=function(o){e.map.panTo(o.location),e.findPlaces(o)},e.findPlaces=function(o){e.loading(!0),e.hasPlaces(!0);var r=function(e){var o='<div class="place-info"><h4>'+e.name+"</h4>";if(e.categories.length>0){o+='<h5 class="categories-titles">'+e.categories[0].name;for(var r=1;r<e.categories.length;++r){var n=e.categories[r];o+=", "+n.pluralName}o+="</h5>"}return e.location.formattedAddress.length>0&&(o+="<br><address>",e.location.formattedAddress.forEach(function(e){o+=e+"<br>"}),o+="</address>"),e.hasOwnProperty("hours")&&e.hours.timeframes.forEach(function(e){o+='<div class="timeframe">';for(var r=e.daysOpen[0],n=1;n<e.daysOpen.length;++n)r+=" - "+e.daysOpen[n];o+="<p>"+r+"</p>",o+="<p>"+e.open.start+" - "+e.open.end+"</p>",o+="</div>"}),o+="</div>",new google.maps.InfoWindow({content:o})};apis.foursquare.getPlacesIn(o.location,function(o){return o.length<=0?(e.hasPlaces(!1),void e.loading(!1)):(e.hasPlaces(!0),void o.forEach(function(o){o.matchesQuery=ko.computed(function(){for(var r=e.searchInputValue().toLowerCase(),n=0;n<o.categories.length;++n)if(-1!=o.categories[n].name.toLowerCase().search(r))return!0;return o.name.substring(0,r.length).toLowerCase()===r}),apis.foursquare.getPhotosOf(o,function(n){o.photos=n.items,o.thumbnail=ko.computed(function(){if(o.photos.length<=0)return"";var e=o.photos[0];return e.prefix+"100x100"+e.suffix});for(var a=0;a<o.photos.length;++a){var t=o.photos[a];t.position=a,t.placeId=o.id,t.preview=ko.computed(function(){return t.prefix+"500x500"+t.suffix})}o.formattedCategories=ko.computed(function(){if(o.categories.length<=0)return"";for(var e=o.categories[0].name,r=1;r<o.categories.length;++r)e+=", "+o.categories[r];return e}),apis.foursquare.getHoursOf(o,function(n){var a=function(e){return e.substring(0,2)+" h "+e.substring(2)};n.hasOwnProperty("timeframes")&&(n.timeframes.forEach(function(e){e.hasOwnProperty("days")&&(e.daysOpen=[],e.days.forEach(function(o){e.daysOpen.push(days[o])}),e.open.start=a(e.open[0].start),e.open.end=a(e.open[0].end))}),o.hours=n),o.infoWindow=r(o),o.infoWindowOpened=ko.observable(!1),o.toggleInfoWindow=function(){this.infoWindowOpened()?(o.marker.setIcon(o.markerIcon),this.infoWindow.close(),this.infoWindowOpened(!1)):(e.map.panTo(this.location),o.marker.setIcon(o.markerIcon.substring(0,o.markerIcon.length-4)+"_selected.png"),this.infoWindow.open(e.map,this.marker),this.infoWindowOpened(!0))},e.categories().forEach(function(r){e.isPlaceInCategory(r,o)&&(o.markerIcon=markers[r.id],o.marker=new google.maps.Marker({map:e.map,title:o.name,position:{lat:o.location.lat,lng:o.location.lng},icon:o.markerIcon}),markersCache.hasOwnProperty(r.id)||(markersCache[r.id]=new Image,markersCache[r.id].src=o.markerIcon.substring(0,o.markerIcon.length-4)+"_selected.png"),r.places.push(o),o.categories.push(r))}),o.hasOwnProperty("marker")&&google.maps.event.addListener(o.marker,"click",function(){if(!o.infoWindowOpened()){o.infoWindow.open(e.map,o.marker);var r=o.marker.getIcon();o.marker.setIcon(r.substring(0,r.length-4)+"_selected.png"),o.infoWindowOpened(!0),document.getElementById(o.id).scrollIntoView()}}),google.maps.event.addListener(o.infoWindow,"closeclick",function(){o.marker.setIcon(o.markerIcon),o.infoWindowOpened(!1)}),e.loading(!1)},e.handleError)},e.handleError)}))},e.handleError)},e.isPlaceInCategory=function(o,r){for(var n=0;n<r.categories.length;++n)if(e.isSubCategoryOf(o,r.categories[n]))return!0;return!1},e.isSubCategoryOf=function(o,r){if(r.id===o.id)return!0;if(o.hasOwnProperty("categories"))for(var n=0;n<o.categories.length;++n)if(e.isSubCategoryOf(o.categories[n],r))return!0;return!1},e.getCategories=function(o){var r=Modernizr.localstorage&&null===localStorage.getItem("categories");r?apis.foursquare.getCategories(function(e){Modernizr.localstorage&&localStorage.setItem("categories",JSON.stringify(e)),o&&o(e)},e.handleError):o&&o(JSON.parse(localStorage.getItem("categories")))},e.handleError=function(o){e.loading(!1),o&&(console.log(o),"object"==typeof o?e.errorText("Can not retrieve all the places. Please reload the page."):"string"==typeof o&&e.errorText(o)),e.error(!0)},"object"==typeof google&&"object"==typeof google.maps&&"object"==typeof google.maps.event&&"object"==typeof google.maps.places?google.maps.event.addDomListener(window,"load",this.initialize):e.handleError("Can not load the map. Please reload the page.")};$(document).ready(function(){ko.applyBindings(new NeighborhoodViewModel)});